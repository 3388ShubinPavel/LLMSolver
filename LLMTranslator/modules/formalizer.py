import ollama
from config import FORMALIZER_PROMPT


class Formalizer:
    """
    –ú–û–î–£–õ–¨ 1: LLM-—Ñ–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä
    –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —è–≤–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
    """

    def __init__(self, model: str = "qwen2.5:7b"):
        self.model = model
        self.system_prompt = FORMALIZER_PROMPT
        self._verify_russian_support()

    def _verify_russian_support(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —É–ª—É—á—à–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞"""
        print("üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –≤ –º–æ–¥–µ–ª–∏...")
        # –î–æ–±–∞–≤–ª—è–µ–º —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–∏–π –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç
        self.system_prompt += "\n\n–ü–û–ú–ù–ò: –¢—ã –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å –†–£–°–°–ö–ò–ú —è–∑—ã–∫–æ–º –∏ –≤—ã–≤–æ–¥–∏—Ç—å —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–£–°–°–ö–ò–• —Ç–µ—Ä–º–∏–Ω–æ–≤!"

    def formalize(self, natural_language_text: str) -> list:
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã
        –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø—Ä–æ–º—Ç—É
        """
        print("üîç –ú–æ–¥—É–ª—å 1 (–§–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä): –ù–∞—á–∏–Ω–∞—é –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –ª–æ–≥–∏–∫—É...")
        print(f"üì• –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: {natural_language_text}")

        try:
            # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –≤ –∑–∞–ø—Ä–æ—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
            enhanced_prompt = f"{self.system_prompt}\n\n–†–£–°–°–ö–ò–ô –¢–ï–ö–°–¢ –î–õ–Ø –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–Ø: {natural_language_text}"

            response = ollama.chat(
                model=self.model,
                messages=[
                    {
                        "role": "system",
                        "content": self.system_prompt  # ‚úÖ –û–±—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    },
                    {
                        "role": "user",
                        "content": f"–ü—Ä–µ–æ–±—Ä–∞–∑—É–π —ç—Ç–æ—Ç —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º—É–ª—ã –ª–æ–≥–∏–∫–∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤: '{natural_language_text}'. –í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û —Ñ–æ—Ä–º—É–ª—ã, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏."
                    }
                ],
                options={
                    'temperature': 0.1,  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç—É
                    'top_k': 1,
                    'top_p': 0.1
                }
            )

            formulas_text = response['message']['content'].strip()
            print(f"üìù –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏: {formulas_text}")

            # –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –≤—ã–≤–æ–¥–∞
            formulas = self._parse_and_validate_formulas(formulas_text, natural_language_text)

            print(f"‚úÖ –ú–æ–¥—É–ª—å 1: –£—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª –≤ {len(formulas)} –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª(—ã)")
            return formulas

        except Exception as e:
            print(f"‚ùå –ú–æ–¥—É–ª—å 1: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –º–æ–¥–µ–ª—å—é: {e}")
            return self._get_enhanced_fallback_formulas(natural_language_text)

    def _parse_and_validate_formulas(self, formulas_text: str, original_text: str) -> list:
        """
        –°—Ç—Ä–æ–≥–æ –ø–∞—Ä—Å–∏—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º—É–ª—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ–º—Ç—É
        """
        formulas_text = formulas_text.strip()

        # –£–î–ê–õ–Ø–ï–ú –í–°–ï –õ–ò–®–ù–ï–ï - —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É–ª—ã!
        lines = formulas_text.split('\n')
        valid_formulas = []

        for line in lines:
            line = line.strip()

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            if not line or line.startswith(('–û–±—ä—è—Å–Ω–µ–Ω–∏–µ', '–ü—Ä–∏–º–µ—Ä', '–í—Ö–æ–¥', '–í—ã–≤–æ–¥', '#')):
                continue

            # –£–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –∏ –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–∞
            clean_line = self._remove_list_markers(line)

            # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ñ–æ—Ä–º—É–ª—É
            parts = clean_line.split(',')
            for part in parts:
                formula = part.strip()
                if self._is_valid_predicate_logic(formula):
                    valid_formulas.append(formula)

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback
        if not valid_formulas:
            print("‚ö†Ô∏è  –ú–æ–¥–µ–ª—å –Ω–µ –≤—ã–¥–∞–ª–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª, –∏—Å–ø–æ–ª—å–∑—É—é —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback")
            return self._get_enhanced_fallback_formulas(original_text)

        return valid_formulas

    def _remove_list_markers(self, text: str) -> str:
        """–£–¥–∞–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ –∏ –Ω—É–º–µ—Ä–∞—Ü–∏—é"""
        markers = ['- ', '‚Ä¢ ', '1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.', '10.']
        for marker in markers:
            if text.startswith(marker):
                return text[len(marker):].strip()
        return text

    def _is_valid_predicate_logic(self, formula: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ñ–æ—Ä–º—É–ª–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É –ª–æ–≥–∏–∫–∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤"""
        formula = formula.strip()

        # –î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Å–∏–º–≤–æ–ª –ª–æ–≥–∏–∫–∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤
        valid_patterns = [
            '(' in formula and ')' in formula,  # –ü—Ä–µ–¥–∏–∫–∞—Ç —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
            '‚àÄ' in formula,  # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–≤–∞–Ω—Ç–æ—Ä
            '‚àÉ' in formula,  # –≠–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–≤–∞–Ω—Ç–æ—Ä
            '‚Üí' in formula,  # –ò–º–ø–ª–∏–∫–∞—Ü–∏—è
            '‚à®' in formula,  # –î–∏–∑—ä—é–Ω–∫—Ü–∏—è
            '‚àß' in formula,  # –ö–æ–Ω—ä—é–Ω–∫—Ü–∏—è
            '¬¨' in formula,  # –û—Ç—Ä–∏—Ü–∞–Ω–∏–µ
        ]

        return any(valid_patterns) and len(formula) > 2

    def _get_enhanced_fallback_formulas(self, text: str) -> list:
        """
        –£–ª—É—á—à–µ–Ω–Ω—ã–π fallback —Å –ª—É—á—à–∏–º –∞–Ω–∞–ª–∏–∑–æ–º —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        """
        text_lower = text.lower()

        # –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º —Ç–∏–ø –∑–∞–¥–∞—á–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        if any(word in text_lower for word in ['—Å–æ–∫—Ä–∞—Ç', '—á–µ–ª–æ–≤–µ–∫', '—Å–º–µ—Ä—Ç–µ–Ω']):
            return ["–ß–µ–ª–æ–≤–µ–∫(–°–æ–∫—Ä–∞—Ç)", "‚àÄx (–ß–µ–ª–æ–≤–µ–∫(x) ‚Üí –°–º–µ—Ä—Ç–µ–Ω(x))", "¬¨–°–º–µ—Ä—Ç–µ–Ω(–°–æ–∫—Ä–∞—Ç)"]

        elif any(word in text_lower for word in ['–∫–æ—à–∫', '–º–ª–µ–∫–æ–ø–∏—Ç–∞—é—â', '–ø–æ–∑–≤–æ–Ω–æ—á–Ω', '–º—É—Ä–∫–∞']):
            return [
                "‚àÄx (–ö–æ—à–∫–∞(x) ‚Üí –ú–ª–µ–∫–æ–ø–∏—Ç–∞—é—â–µ–µ(x))",
                "‚àÄx (–ú–ª–µ–∫–æ–ø–∏—Ç–∞—é—â–µ–µ(x) ‚Üí –ü–æ–∑–≤–æ–Ω–æ—á–Ω–æ–µ(x))",
                "–ö–æ—à–∫–∞(–ú—É—Ä–∫–∞)",
                "¬¨–ü–æ–∑–≤–æ–Ω–æ—á–Ω–æ–µ(–ú—É—Ä–∫–∞)"
            ]

        elif any(word in text_lower for word in ['–ø—Ç–∏—Ü', '–ª–µ—Ç–∞', '–ø–∏–Ω–≥–≤–∏–Ω']):
            return ["‚àÄx (–ü—Ç–∏—Ü–∞(x) ‚Üí –õ–µ—Ç–∞–µ—Ç(x))", "–ü—Ç–∏—Ü–∞(–ü–∏–Ω–≥–≤–∏–Ω)", "¬¨–õ–µ—Ç–∞–µ—Ç(–ü–∏–Ω–≥–≤–∏–Ω)"]

        elif any(word in text_lower for word in ['–¥–æ–∂–¥', '–º–æ–∫—Ä', '—É–ª–∏—Ü']):
            return ["–î–æ–∂–¥—å ‚Üí –ú–æ–∫—Ä–∞—è–£–ª–∏—Ü–∞", "–ú–æ–∫—Ä–∞—è–£–ª–∏—Ü–∞", "¬¨–î–æ–∂–¥—å"]

        else:
            # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ–±—â–∏—Ö —Å–ª—É—á–∞–µ–≤
            words = text_lower.split()
            objects = [word for word in words if len(word) > 3 and word.isalpha()]
            if objects:
                main_object = objects[0].capitalize()
                return [f"–ü—Ä–µ–¥–∏–∫–∞—Ç({main_object})", "‚àÄx (–£—Å–ª–æ–≤–∏–µ(x) ‚Üí –°–ª–µ–¥—Å—Ç–≤–∏–µ(x))", f"¬¨–î–æ–∫–∞–∑—ã–≤–∞–µ–º–æ–µ({main_object})"]
            else:
                return ["A(–æ–±—ä–µ–∫—Ç)", "‚àÄx (B(x) ‚Üí C(x))", "¬¨D(–æ–±—ä–µ–∫—Ç)"]