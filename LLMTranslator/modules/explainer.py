import ollama
from config import EXPLAINER_PROMPT


class Explainer:
    """
    –ú–û–î–£–õ–¨ 3: LLM-–æ–±—ä—è—Å–Ω—è—Ç–æ—Ä
    –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
    """

    def __init__(self, model: str = "qwen2.5:7b"):
        self.model = model
        self.system_prompt = self._create_enhanced_system_prompt()

    def _create_enhanced_system_prompt(self):
        """–°–æ–∑–¥–∞–µ—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π"""
        return """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä—è—Å–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–º –∏ –ø–æ–Ω—è—Ç–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –û–±—ä—è—Å–Ω—è—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ö–ê–ö –ù–ê–°–¢–û–Ø–©–ò–ô –£–ß–ò–¢–ï–õ–¨
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π, —è—Å–Ω—ã–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–≥–∏—á–µ—Å–∫—É—é —Ü–µ–ø–æ—á–∫—É —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
- –û–±—ä—è—Å–Ω—è—Ç—å, –≤ —á–µ–º –∏–º–µ–Ω–Ω–æ —Å–æ—Å—Ç–æ–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ
- –î–µ–ª–∞—Ç—å –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ, –∞ –Ω–µ –Ω–∞ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏

–§–û–†–ú–ê–¢ –û–ë–™–Ø–°–ù–ï–ù–ò–Ø:
1. –ö—Ä–∞—Ç–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å
2. –ü–æ–∫–∞–∂–∏ –∫–ª—é—á–µ–≤—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏
3. –û–±—ä—è—Å–Ω–∏, –≥–¥–µ –∏ –ø–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–ª–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ
4. –°–¥–µ–ª–∞–π —á–µ—Ç–∫–∏–π –≤—ã–≤–æ–¥

–ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑! –û–±—ä—è—Å–Ω—è–π –∂–∏–≤–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ."""

    def explain_proof(self, logical_steps: list, original_query: str, proof_success: bool) -> str:
        """
        –û–±—ä—è—Å–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
        """
        print("üéì –ú–æ–¥—É–ª—å 3 (–û–±—ä—è—Å–Ω—è—Ç–æ—Ä): –ù–∞—á–∏–Ω–∞—é –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —à–∞–≥–æ–≤ –≤ —Ä—É—Å—Å–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ...")
        print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞: {'–£–°–ü–ï–•' if proof_success else '–ù–ï–£–î–ê–ß–ê'}")
        print(f"üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤: {len(logical_steps)}")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
        steps_text = self._create_detailed_steps_text(logical_steps, original_query, proof_success)

        try:
            response = ollama.chat(
                model=self.model,
                messages=[
                    {
                        "role": "system",
                        "content": self.system_prompt
                    },
                    {
                        "role": "user",
                        "content": steps_text
                    }
                ],
                options={
                    'temperature': 0.4,  # –ù–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
                    'top_p': 0.9,
                    'num_predict': 1000  # –î–∞–µ–º –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
                }
            )

            explanation = response['message']['content'].strip()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
            if self._is_good_explanation(explanation):
                print("‚úÖ –ú–æ–¥—É–ª—å 3: –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ")
                return explanation
            else:
                print("‚ö†Ô∏è  –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback")
                return self._create_quality_explanation(logical_steps, original_query, proof_success)

        except Exception as e:
            print(f"‚ùå –ú–æ–¥—É–ª—å 3: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è: {e}")
            return self._create_quality_explanation(logical_steps, original_query, proof_success)

    def _create_detailed_steps_text(self, logical_steps: list, original_query: str, proof_success: bool) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —à–∞–≥–æ–≤ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è"""
        steps_text = "\n".join([f"–®–∞–≥ {i + 1}: {step}" for i, step in enumerate(logical_steps)])

        return f"""
–ò–°–•–û–î–ù–´–ô –í–û–ü–†–û–°: {original_query}

–†–ï–ó–£–õ–¨–¢–ê–¢ –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê: {'–£–°–ü–ï–®–ù–û - –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –Ω–∞–π–¥–µ–Ω–æ' if proof_success else '–ù–ï–£–î–ê–ß–ê'}

–ü–û–õ–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –õ–û–ì–ò–ß–ï–°–ö–ò–• –®–ê–ì–û–í:
{steps_text}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—ä—è—Å–Ω–∏ —ç—Ç–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π —É—á–∏—Ç–µ–ª—å. –ü–æ–∫–∞–∂–∏:
1. –ö–∞–∫ –∏–∑ –ø–æ—Å—ã–ª–æ–∫ –ø–æ–ª—É—á–∞—é—Ç—Å—è –≤—ã–≤–æ–¥—ã
2. –í —á–µ–º —Å–æ—Å—Ç–æ–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ
3. –ü–æ—á–µ–º—É —ç—Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

–û–±—ä—è—Å–Ω—è–π –Ω–∞ –ü–û–ù–Ø–¢–ù–û–ú –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –∫–∞–∫ –±—É–¥—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—à—å —É—á–µ–Ω–∏–∫—É.
"""

    def _is_good_explanation(self, explanation: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è"""
        if not explanation or len(explanation) < 100:
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ö–æ—Ä–æ—à–µ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
        has_russian = any(word in explanation.lower() for word in
                          ['–ø–æ—Ç–æ–º—É —á—Ç–æ', '—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ', '–∏–∑ —ç—Ç–æ–≥–æ', '–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ', '–∑–Ω–∞—á–∏—Ç'])
        has_structure = any(marker in explanation for marker in ['\n', '1.', '2.', '‚Ä¢', '- '])

        return has_russian and len(explanation) > 150

    def _create_quality_explanation(self, steps: list, query: str, proof_success: bool) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ 3
        """
        if proof_success:
            return self._create_success_explanation_v3(steps, query)
        else:
            return self._create_failure_explanation_v3(steps, query)

    def _create_success_explanation_v3(self, steps: list, query: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ —Å—Ç–∏–ª–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ 3"""

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —à–∞–≥–∏ —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
        contradiction_found = any('–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ' in step.lower() or '‚óª' in step for step in steps)
        resolution_steps = [step for step in steps if '—Ä–µ–∑–æ–ª—é—Ü–∏—è' in step.lower()]

        explanation = [
            "üéâ –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û!",
            "",
            f"–ò—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å: ¬´{query}¬ª",
            "",
            "–ö–†–ê–¢–ö–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:",
            ""
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —à–∞–≥–æ–≤
        if resolution_steps:
            explanation.append("–ö–ª—é—á–µ–≤—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏:")
            for i, step in enumerate(resolution_steps[-3:], 1):  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Ä–µ–∑–æ–ª—é—Ü–∏–∏
                explanation.append(f"{i}. {step}")
            explanation.append("")

        explanation.extend([
            "–¶–µ–ø–æ—á–∫–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –ø—Ä–∏–≤–µ–ª–∞ –∫ –¥–≤—É–º –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º –≤—ã–≤–æ–¥–∞–º:",
            "1. –° –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏–∑ –æ–±—â–∏—Ö –ø—Ä–∞–≤–∏–ª —Å–ª–µ–¥—É–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥",
            "2. –° –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, —Ñ–∞–∫—Ç—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç —ç—Ç–æ–º—É –≤—ã–≤–æ–¥—É",
            "",
            "–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏—Å—Ç–∏–Ω–Ω–æ—Å—Ç—å —ç—Ç–∏—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞, —á—Ç–æ –∏ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø–æ—Å—ã–ª–∫–∞—Ö.",
            "",
            "–í–´–í–û–î: –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–∫–∞–∑–∞–Ω–æ. –ò—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–Ω—ã."
        ])

        return "\n".join(explanation)

    def _create_failure_explanation_v3(self, steps: list, query: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞"""
        return f"""
‚ùå –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û –ù–ï –£–î–ê–õ–û–°–¨

–ò—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å: ¬´{query}¬ª

–ß–¢–û –ü–†–û–ò–ó–û–®–õ–û:
–í—ã–ø–æ–ª–Ω–µ–Ω–æ {len(steps)} –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —à–∞–≥–æ–≤, –Ω–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.

–í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´:

üîç –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
   - –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Å—ã–ª–∫–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
   - –ò–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤

ü§î –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
   - –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏
   - –ò–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ —Å–∫—Ä—ã—Ç–æ –≥–ª—É–±–æ–∫–æ –≤ –ª–æ–≥–∏–∫–µ

–ß–¢–û –≠–¢–û –ó–ù–ê–ß–ò–¢:
–≠—Ç–æ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ª–æ–∂–Ω–æ, –Ω–æ –≤ —Ä–∞–º–∫–∞—Ö —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ 
–º—ã –Ω–µ –º–æ–∂–µ–º —Å—Ç—Ä–æ–≥–æ –¥–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–Ω–æ—Ç—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø–æ—Å—ã–ª–æ–∫.
"""